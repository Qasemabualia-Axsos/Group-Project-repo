{% extends "base.html" %}
{% load static %}

{% block title %}Reviews{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Movie Header -->
  <div class="text-center mb-5 p-4 rounded-4 shadow-lg bg-black bg-opacity-75">
    <img src="{{ movie.cover_img.url }}" alt="{{ movie.title }}"
         class="img-fluid rounded-3 mb-3"
         style="max-height: 300px; object-fit: cover;">
    <h2 class="fw-bold text-warning">{{ movie.title }}</h2>
    <p class="text-light mb-2">{{ movie.description }}</p>
    <p class="text-secondary"><strong>Release Date:</strong> {{ movie.release_date }}</p>
    {% if movie.trailer %}
    <a href="{{ movie.trailer }}" target="_blank" class="btn btn-warning text-dark fw-semibold rounded-3">
      ðŸŽ¥ Watch Trailer
    </a>
    {% endif %}
  </div>

  <!-- Add Review Form -->
  {% if request.session.userid %}
  <div class="card bg-dark bg-opacity-75 border-0 shadow-lg mb-5 p-4">
    <h4 class="text-warning fw-semibold text-center mb-4">Leave a Review</h4>

    <form id="reviewForm" method="POST" action="{% url 'reviews:movie_reviews' movie.id %}">
      {% csrf_token %}
      <input type="hidden" name="review_id" value="">
      <input type="hidden" name="action" value="add">

      <div class="mb-3 text-center">
        <label class="form-label fw-semibold text-light d-block mb-2">Your Rating:</label>
        <div class="star-rating mx-auto">
          {% for i in "54321"|make_list %}
          <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}">
          <label for="star{{ i }}" title="{{ i }} stars">â˜…</label>
          {% endfor %}
        </div>
      </div>

      <div class="mb-4">
        <textarea 
          name="comment" 
          class="form-control bg-black bg-opacity-50 text-light border-warning rounded-3 shadow-sm" 
          placeholder="Share your thoughts about this movie..." 
          rows="3" 
          required
        ></textarea>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-warning text-dark fw-semibold px-4 py-2 rounded-3">
          Add Review
        </button>
      </div>
    </form>
  </div>
  {% else %}
  <p class="text-center text-light">
    <a href="{% url 'accounts:login_page' %}" class="text-warning fw-semibold">Log in</a> to leave a review.
  </p>
  {% endif %}

  <!-- All Reviews Section -->
  <div class="reviews-section p-4 rounded-4 bg-black bg-opacity-75 shadow-lg">
    <h4 class="text-warning fw-bold mb-4 text-center">All Reviews</h4>
    <div class="row g-4" id="reviewsContainer">
      {% include 'reviews/reviews_list.html' %}
    </div>
  </div>

</div>

<!-- AJAX Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector("#reviewForm");
  const reviewsContainer = document.querySelector("#reviewsContainer");
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  if (!form) return;

  // Handle Add / Update Review
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const action = formData.get("review_id") ? "update" : "add";
    formData.set("action", action);

    fetch("", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" },
      body: formData,
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        reviewsContainer.innerHTML = data.html;
        form.reset();
        form.querySelector("input[name='review_id']").value = "";
      }
      alert(data.message);
    });
  });

  // Handle Delete or Edit Review
  reviewsContainer.addEventListener("click", (e) => {
    if (e.target.closest(".delete-review")) {
      const reviewId = e.target.closest(".delete-review").dataset.id;
      const formData = new FormData();
      formData.append("action", "delete");
      formData.append("review_id", reviewId);

      fetch("", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" },
        body: formData,
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          reviewsContainer.innerHTML = data.html;
        }
        alert(data.message);
      });
    }

    if (e.target.closest(".edit-review")) {
      const btn = e.target.closest(".edit-review");
      document.querySelector("input[name='review_id']").value = btn.dataset.id;
      document.querySelector(`#star${btn.dataset.rating}`).checked = true;
      document.querySelector("textarea[name='comment']").value = btn.dataset.comment;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  });
});
</script>

<!-- Styling -->
<style>
:root {
  --yellow: #f5c518;
  --dark-bg: #0d0d0d;
  --gray-bg: rgba(40, 40, 40, 0.95);
  --text-gray: #cfcfcf;
  --comment-bg: #1a1a1a;
  --comment-text: #000000; 
}

body {
  background-color: var(--dark-bg);
  color: var(--text-gray);
}


textarea::placeholder {
  color: white !important;
  opacity: 0.8;
}

/* Stars */
.star-rating {
  direction: rtl;
  display: inline-flex;
  gap: 5px;
}
.star-rating input {
  display: none;
}
.star-rating label {
  font-size: 2rem;
  color: #555;
  cursor: pointer;
  transition: color 0.2s ease-in-out;
}
.star-rating input:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
  color: var(--yellow);
}

/* Reviews Section */
.reviews-section {
  background: var(--gray-bg);
  border: 1px solid rgba(245, 197, 24, 0.3);
}
.review-card {
  background: var(--comment-bg);
  border: 1px solid rgba(245, 197, 24, 0.2);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
}
.review-card:hover {
  transform: translateY(-3px);
}
.username {
  color: var(--yellow);
  font-weight: 600;
  font-size: 1.1rem;
}
.comment-text {
  color: var(--comment-text); 
  font-size: 1rem;
  line-height: 1.6;
  margin-top: 8px;
}

/* Buttons */
.btn-warning {
  background-color: var(--yellow);
  border: none;
  transition: all 0.3s ease;
}
.btn-warning:hover {
  background-color: #ffd633;
  transform: translateY(-2px);
}

/* Edit / Delete buttons */
.review-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 10px;
}
.action-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: rgba(245, 197, 24, 0.08);
  border: 1px solid rgba(245, 197, 24, 0.3);
  color: var(--yellow);
  font-size: 0.9rem;
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.action-btn:hover {
  background: var(--yellow);
  color: #000;
  transform: translateY(-2px);
  box-shadow: 0 0 8px rgba(245, 197, 24, 0.3);
}
.action-btn i {
  font-size: 1rem;
}
</style>
{% endblock %}


