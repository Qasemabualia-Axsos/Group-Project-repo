{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">


  <div class="text-center mb-5 p-4 rounded shadow bg-white">
    <img src="{{ movie.cover_img.url }}" alt="{{ movie.title }}"
         class="img-fluid rounded mb-3"
         style="max-height: 300px; object-fit: cover;">
    <h2 class="fw-bold text-dark">{{ movie.title }}</h2>
    <p class="text-muted mb-2">{{ movie.description }}</p>
    <p><strong>Release Date:</strong> {{ movie.release_date }}</p>
    {% if movie.trailer %}
    <a href="{{ movie.trailer }}" target="_blank" class="btn btn-watch">ðŸŽ¥ Watch Trailer</a>
    {% endif %}
  </div>

  
  {% if request.session.userid %}
  <div class="card border-0 shadow-sm mb-5">
    <div class="card-body p-4">
      <h4 class="card-title text-center mb-4 text-primary fw-semibold">Leave a Review</h4>

      <form id="reviewForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="review_id" value="">
        <input type="hidden" name="action" value="add">

        <div class="mb-4 text-center">
          <label class="form-label fw-semibold d-block mb-2">Your Rating:</label>
          <div class="star-rating mx-auto">
            {% for i in "54321"|make_list %}
            <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" />
            <label for="star{{ i }}" title="{{ i }} stars">â˜…</label>
            {% endfor %}
          </div>
        </div>

        <div class="mb-4">
          <label for="comment" class="form-label fw-semibold">Comment</label>
          <textarea class="form-control shadow-sm rounded-3" id="comment" name="comment"
                    rows="4" placeholder="Share your thoughts..."></textarea>
        </div>

        <div class="text-center">
          <button type="submit" class="btn btn-submit px-4 py-2 rounded-3">Submit Review</button>
        </div>
      </form>
    </div>
  </div>
  {% else %}
    <p class="text-center">
      <a href="{% url 'accounts:login_page' %}" class="text-primary fw-semibold">Log in</a> to leave a review.
    </p>
  {% endif %}

  
  <h4 class="text-center text-primary fw-bold mb-4">All Reviews</h4>
  <div class="row g-3" id="reviewsContainer">
    {% include 'reviews/reviews_list.html' %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector("#reviewForm");
  const reviewsContainer = document.querySelector("#reviewsContainer");
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  if (!form) return;


  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const action = formData.get("review_id") ? "update" : "add";
    formData.set("action", action);

    fetch("", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" },
      body: formData,
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        reviewsContainer.innerHTML = data.html;
        form.reset();
        form.querySelector("input[name='review_id']").value = "";
        alert(data.message);
      } else {
        alert(data.message);
      }
    });
  });

  // Handle Delete or Edit Review
  reviewsContainer.addEventListener("click", (e) => {
    if (e.target.classList.contains("delete-review")) {
      const reviewId = e.target.dataset.id;
      const formData = new FormData();
      formData.append("action", "delete");
      formData.append("review_id", reviewId);

      fetch("", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" },
        body: formData,
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          reviewsContainer.innerHTML = data.html;
          alert("Review deleted successfully!");
        }
      });
    }

    if (e.target.classList.contains("edit-review")) {
      const btn = e.target;
      document.querySelector("input[name='review_id']").value = btn.dataset.id;
      document.querySelector(`#star${btn.dataset.rating}`).checked = true;
      document.querySelector("#comment").value = btn.dataset.comment;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  });
});
</script>

<style>
:root {
  --primary: #0056b3;
  --secondary: #f1c40f;
  --bg-light: #f8f9fa;
  --text-dark: #333333;
}

body {
  background-color: var(--bg-light);
}

.card {
  background-color: #ffffff;
  border-radius: 15px;
}
.star-rating {
  direction: rtl;
  display: inline-flex;
  gap: 5px;
}
.star-rating input {
  display: none;
}
.star-rating label {
  font-size: 2rem;
  color: #ccc;
  cursor: pointer;
  transition: color 0.2s ease-in-out;
}
.star-rating input:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
  color: var(--secondary);
}

.btn-watch {
  background: linear-gradient(135deg, var(--secondary) 0%, #ffde59 100%);
  color: #333;
  border: none;
  font-weight: 600;
  border-radius: 8px;
  padding: 8px 16px;
  transition: all 0.3s ease;
}
.btn-watch:hover {
  background: linear-gradient(135deg, #ffcf00 0%, var(--secondary) 100%);
  transform: translateY(-2px);
}

.btn-submit {
  background: linear-gradient(135deg, var(--primary) 0%, #007bff 100%);
  color: white;
  font-weight: 600;
  border: none;
  transition: all 0.3s ease;
}
.btn-submit:hover {
  background: linear-gradient(135deg, #003f87 0%, var(--primary) 100%);
  transform: translateY(-2px);
}

.btn-action, .btn-delete {
  font-size: 0.9rem;
  padding: 6px 14px;
  border-radius: 8px;
  font-weight: 600;
  border: none;
  transition: all 0.3s ease;
}

.btn-action {
  background: linear-gradient(135deg, var(--primary) 0%, #007bff 100%);
  color: white;
  box-shadow: 0 2px 6px rgba(0, 91, 187, 0.3);
}
.btn-action:hover {
  background: linear-gradient(135deg, #003f87 0%, #0056b3 100%);
  transform: translateY(-2px);
}

.btn-delete {
  background: linear-gradient(135deg, #ff5c5c 0%, #ff7878 100%);
  color: white;
  box-shadow: 0 2px 6px rgba(255, 90, 90, 0.3);
}
.btn-delete:hover {
  background: linear-gradient(135deg, #e04a4a 0%, #ff5c5c 100%);
  transform: translateY(-2px);
}

.review-card {
  border-left: 5px solid var(--primary);
  background-color: #ffffff;
}
.username {
  color: var(--primary);
  font-weight: 600;
}
.comment-text {
  color: var(--text-dark);
  font-size: 1rem;
  line-height: 1.6;
}
</style>
{% endblock %}


















